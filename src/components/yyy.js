const gitlabIssuesInput = [
  {"id":176793422,"iid":4,"project_id":75943662,"title":"IAM permission","description":"","state":"opened","created_at":"2025-11-09T14:58:25.935Z","updated_at":"2025-11-09T14:58:25.935Z","closed_at":null,"closed_by":null,"labels":["BAU","critical"],"milestone":null,"assignees":[],"author":{"id":5114354,"username":"nantha-a","public_email":"","name":"Nanthagopal A","state":"active","locked":false,"avatar_url":"https://secure.gravatar.com/avatar/3322a75d281d1a86d9263a6ee9b32089f21e2e679112f2216aa936fe6ea3ae81?s=80\u0026d=identicon","web_url":"https://gitlab.com/nantha-a"},"type":"ISSUE","assignee":null,"user_notes_count":0,"merge_requests_count":0,"upvotes":0,"downvotes":0,"due_date":null,"confidential":false,"discussion_locked":null,"issue_type":"issue","web_url":"https://gitlab.com/cloudopsedge/tickets/support-infra/-/issues/4","time_stats":{"time_estimate":0,"total_time_spent":0,"human_time_estimate":null,"human_total_time_spent":null},"task_completion_status":{"count":0,"completed_count":0},"blocking_issues_count":0,"has_tasks":true,"task_status":"","_links":{"self":"https://gitlab.com/api/v4/projects/75943662/issues/4","notes":"https://gitlab.com/api/v4/projects/75943662/issues/4/notes","award_emoji":"https://gitlab.com/api/v4/projects/75943662/issues/4/award_emoji","project":"https://gitlab.com/api/v4/projects/75943662","closed_as_duplicate_of":null},"references":{"short":"#4","relative":"#4","full":"cloudopsedge/tickets/support-infra#4"},"severity":"UNKNOWN","moved_to_id":null,"imported":false,"imported_from":"none","service_desk_reply_to":null},{"id":176793398,"iid":3,"project_id":75943662,"title":"App2 requirement","description":"","state":"opened","created_at":"2025-11-09T14:56:30.658Z","updated_at":"2025-11-09T14:56:30.658Z","closed_at":null,"closed_by":null,"labels":["app:app2","feature"],"milestone":null,"assignees":[],"author":{"id":5114354,"username":"nantha-a","public_email":"","name":"Nanthagopal A","state":"active","locked":false,"avatar_url":"https://secure.gravatar.com/avatar/3322a75d281d1a86d9263a6ee9b32089f21e2e679112f2216aa936fe6ea3ae81?s=80\u0026d=identicon","web_url":"https://gitlab.com/nantha-a"},"type":"ISSUE","assignee":null,"user_notes_count":0,"merge_requests_count":0,"upvotes":0,"downvotes":0,"due_date":null,"confidential":false,"discussion_locked":null,"issue_type":"issue","web_url":"https://gitlab.com/cloudopsedge/tickets/support-infra/-/issues/3","time_stats":{"time_estimate":0,"total_time_spent":0,"human_time_estimate":null,"human_total_time_spent":null},"task_completion_status":{"count":0,"completed_count":0},"blocking_issues_count":0,"has_tasks":true,"task_status":"","_links":{"self":"https://gitlab.com/api/v4/projects/75943662/issues/3","notes":"https://gitlab.com/api/v4/projects/75943662/issues/3/notes","award_emoji":"https://gitlab.com/api/v4/projects/75943662/issues/3/award_emoji","project":"https://gitlab.com/api/v4/projects/75943662","closed_as_duplicate_of":null},"references":{"short":"#3","relative":"#3","full":"cloudopsedge/tickets/support-infra#3"},"severity":"UNKNOWN","moved_to_id":null,"imported":false,"imported_from":"none","service_desk_reply_to":null},{"id":176791526,"iid":2,"project_id":75943662,"title":"Install Software Pre-requisites","description":null,"state":"opened","created_at":"2025-11-09T13:03:22.035Z","updated_at":"2025-11-09T13:11:01.351Z","closed_at":null,"closed_by":null,"labels":["BAU"],"milestone":null,"assignees":[{"id":5114354,"username":"nantha-a","public_email":"","name":"Nanthagopal A","state":"active","locked":false,"avatar_url":"https://secure.gravatar.com/avatar/3322a75d281d1a86d9263a6ee9b32089f21e2e679112f2216aa936fe6ea3ae81?s=80\u0026d=identicon","web_url":"https://gitlab.com/nantha-a"}],"author":{"id":5114354,"username":"nantha-a","public_email":"","name":"Nanthagopal A","state":"active","locked":false,"avatar_url":"https://secure.gravatar.com/avatar/3322a75d281d1a86d9263a6ee9b32089f21e2e679112f2216aa936fe6ea3ae81?s=80\u0026d=identicon","web_url":"https://gitlab.com/nantha-a"},"type":"TASK","assignee":{"id":5114354,"username":"nantha-a","public_email":"","name":"Nanthagopal A","state":"active","locked":false,"avatar_url":"https://gitlab.com/nantha-a"},"user_notes_count":0,"merge_requests_count":0,"upvotes":0,"downvotes":0,"due_date":null,"confidential":false,"discussion_locked":null,"issue_type":"task","web_url":"https://gitlab.com/cloudopsedge/tickets/support-infra/-/work_items/2","time_stats":{"time_estimate":0,"total_time_spent":0,"human_time_estimate":null,"human_total_time_spent":null},"task_completion_status":{"count":0,"completed_count":0},"blocking_issues_count":0,"has_tasks":true,"task_status":"","_links":{"self":"https://gitlab.com/api/v4/projects/75943662/issues/2","notes":"https://gitlab.com/api/v4/projects/75943662/issues/2/notes","award_emoji":"https://gitlab.com/api/v4/projects/75943662/issues/2/award_emoji","project":"https://gitlab.com/api/v4/projects/75943662","closed_as_duplicate_of":null},"references":{"short":"#2","relative":"#2","full":"cloudopsedge/tickets/support-infra#2"},"severity":"UNKNOWN","moved_to_id":null,"imported":false,"imported_from":"none","service_desk_reply_to":null},{"id":176791520,"iid":1,"project_id":75943662,"title":"Backstage Integration","description":"","state":"opened","created_at":"2025-11-09T13:02:59.296Z","updated_at":"2025-11-09T14:49:51.887Z","closed_at":null,"closed_by":null,"labels":["Hold","Platform","app:app1"],"milestone":null,"assignees":[{"id":5114354,"username":"nantha-a","public_email":"","name":"Nanthagopal A","state":"active","locked":false,"avatar_url":"https://secure.gravatar.com/avatar/3322a75d281d1a86d9263a6ee9b32089f21e2e679112f2216aa936fe6ea3ae81?s=80\u0026d=identicon","web_url":"https://gitlab.com/nantha-a"}],"author":{"id":5114354,"username":"nantha-a","public_email":"","name":"Nanthagopal A","state":"active","locked":false,"avatar_url":"https://secure.gravatar.com/avatar/3322a75d281d1a86d9263a6ee9b32089f21e2e679112f2216aa936fe6ea3ae81?s=80\u0026d=identicon","web_url":"https://gitlab.com/nantha-a"},"type":"ISSUE","assignee":{"id":5114354,"username":"nantha-a","public_email":"","name":"Nanthagopal A","state":"active","locked":false,"avatar_url":"https://secure.gravatar.com/avatar/3322a75d281d1a86d9263a6ee9b32089f21e2e679112f2216aa936fe6ea3ae81?s=80\u0026d=identicon","web_url":"https://gitlab.com/nantha-a"},"user_notes_count":0,"merge_requests_count":0,"upvotes":0,"downvotes":0,"due_date":null,"confidential":false,"discussion_locked":null,"issue_type":"issue","web_url":"https://gitlab.com/cloudopsedge/tickets/support-infra/-/issues/1","time_stats":{"time_estimate":0,"total_time_spent":0,"human_time_estimate":null,"human_total_time_spent":null},"task_completion_status":{"count":0,"completed_count":0},"blocking_issues_count":0,"has_tasks":true,"task_status":"","_links":{"self":"https://gitlab.com/api/v4/projects/75943662/issues/1","notes":"https://gitlab.com/api/v4/projects/75943662/issues/1/notes","award_emoji":"https://gitlab.com/api/v4/projects/75943662/issues/1/award_emoji","project":"https://gitlab.com/api/v4/projects/75943662","closed_as_duplicate_of":null},"references":{"short":"#1","relative":"#1","full":"cloudopsedge/tickets/support-infra#1"},"severity":"UNKNOWN","moved_to_id":null,"imported":false,"imported_from":"none","service_desk_reply_to":null}
];


const SINGLE_PROJECT_ID = 75943662;
const APP_PREFIX = "app:";
const GENERAL_APP_NAME = "General"; // Name for issues without specific 'app:' labels

function transformGitLabIssuesToApplicationsData(gitlabIssues) {
  const allGeneralLabels = new Set(); // Stores all unique general labels (non-app prefixed)
  const allLabelsFound = new Set();   // Stores ALL unique labels (including app: ones)

  // Map to hold data for each application, keyed by app name (e.g., 'app1', 'app2', 'General')
  const applicationDataMap = new Map();

  gitlabIssues.forEach(issue => {
    if (issue.project_id !== SINGLE_PROJECT_ID) {
      console.warn(`Issue ${issue.iid} belongs to a different project (${issue.project_id}). Skipping.`);
      return;
    }

    const currentIssueAppLabels = issue.labels.filter(label => label.startsWith(APP_PREFIX));
    let targetAppNames = [];

    if (currentIssueAppLabels.length > 0) {
      // If issue has app: labels, it contributes to those specific applications
      targetAppNames = currentIssueAppLabels.map(label => label.substring(APP_PREFIX.length));
    } else {
      // If no app: labels, it contributes to the 'General' application
      targetAppNames.push(GENERAL_APP_NAME);
    }

    // Ensure all labels (general and app:) are recorded globally
    issue.labels.forEach(label => {
      allLabelsFound.add(label);
      if (!label.startsWith(APP_PREFIX)) {
        allGeneralLabels.add(label);
      }
    });

    // For each application this issue belongs to, update its counts
    targetAppNames.forEach(appName => {
      if (!applicationDataMap.has(appName)) {
        applicationDataMap.set(appName, {
          name: appName,
          issuesByLabel: {}
        });
      }
      const appData = applicationDataMap.get(appName);

      issue.labels.forEach(label => {
        appData.issuesByLabel[label] = (appData.issuesByLabel[label] || 0) + 1;
      });
    });
  });

  // Finalize the top-level 'labels' array
  const finalLabels = Array.from(allGeneralLabels).sort();

  // Finalize the 'applications' array, ensuring consistent structure for issuesByLabel
  const finalApplications = Array.from(applicationDataMap.values()).map(app => {
    const issuesByLabelWithAllLabels = {};
    // Ensure every label (from the entire dataset) is present, even if count is 0 for this app
    Array.from(allLabelsFound).sort().forEach(label => {
      issuesByLabelWithAllLabels[label] = app.issuesByLabel[label] || 0;
    });
    return {
      name: app.name,
      issuesByLabel: issuesByLabelWithAllLabels
    };
  }).sort((a, b) => a.name.localeCompare(b.name)); // Sort applications by name

  return {
    labels: finalLabels,
    applications: finalApplications
  };
}

const transformedData = transformGitLabIssuesToApplicationsData(gitlabIssuesInput);
console.log(JSON.stringify(transformedData, null, 2));